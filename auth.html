<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ”¥ Authentication - Blog.in</title>
  <meta name="description"
    content="Login or Sign Up to Blog.in to start writing and sharing your stories with the world.">
  <link rel="canonical" href="https://blog--in.vercel.app/auth" />
  <link rel="icon" type="image/png" href="./assets/images/blog.in.png">

  <!-- Flaticon/Icons -->
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css" />
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-solid-rounded/css/uicons-solid-rounded.css" />
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-brands/css/uicons-brands.css" />

  <link rel="stylesheet" href="./css/main.css">
  <link rel="stylesheet" href="./css/auth.css">
  <link rel="stylesheet" href="./css/navbar.css">
  <link rel="stylesheet" href="./css/footer.css">
</head>

<body class="auth-page">
  <div id="navbar-placeholder"></div>

  <main class="auth-container">
    <section class="auth-illustration">
      <img src="./assets/images/blog.in.png" alt="Auth Illustration">
      <h2>Welcome to <span class="brand">BlogPlatform</span> âœ¨</h2>
      <p>Login or create an account to share your stories with the world.</p>
    </section>

    <section class="auth-form-card">

      <div class="auth-toggle">
        <button id="login-tab" class="active">Login</button>
        <button id="signup-tab">Signup</button>
      </div>

      <form id="login-form" class="auth-form">
        <h2>Login</h2>
        <input type="email" id="login-email" placeholder="Email" required>
        <div class="password-wrapper">
          <input type="password" id="login-pass" placeholder="Password" required>
          <button type="button" class="toggle-password" id="toggleLoginPass" tabindex="-1">
            <i class="fi fi-rr-eye"></i>
          </button>
        </div>

        <button type="button" id="login-btn">Login</button>

        <button type="button" class="google-auth-btn">
          <img src="./assets/images/google.png" alt="Google Logo">
          Continue with Google
        </button>

        <p class="auth-links">
          <a href="./forgot.html">Forgot password?</a>
        </p>
      </form>

      <form id="signup-form" class="auth-form hidden">
        <h2>Create Account</h2>
        <input type="text" id="signup-name" placeholder="Full Name" required>
        <div id="signup-name-feedback" class="validation-feedback"></div>

        <input type="email" id="signup-email" placeholder="Email" required>
        <div id="signup-email-feedback" class="validation-feedback"></div>

        <div class="password-wrapper">
          <input type="password" id="signup-pass" placeholder="Password" required>
          <button type="button" class="toggle-password" id="toggleSignupPass" tabindex="-1">
            <i class="fi fi-rr-eye"></i>
          </button>
        </div>
        <div id="signup-pass-feedback" class="validation-feedback"></div>

        <button type="button" id="signup-btn">Signup</button>

        <button type="button" class="google-auth-btn">
          <img src="./assets/images/google.png" alt="Google Logo">
          Continue with Google
        </button>
      </form>
    </section>
  </main>

  <div id="footer-placeholder"></div>

  <script type="module" src="./js/navbar.js"></script>
  <script type="module" src="./js/footer.js"></script>

  <script type="module">
    import { login, signup, loginWithGoogle } from "/js/supabase/auth.js";
    import { supabase } from "/js/supabase/supabaseClient.js";

    // --- VALIDATION LOGIC ---
    let isSignupNameValid = false;
    let isSignupEmailValid = false;
    let isSignupPassValid = false;

    const signupNameInput = document.getElementById("signup-name");
    const signupNameFeedback = document.getElementById("signup-name-feedback");

    const signupEmailInput = document.getElementById("signup-email");
    const signupEmailFeedback = document.getElementById("signup-email-feedback");

    const signupPassInput = document.getElementById("signup-pass");
    const signupPassFeedback = document.getElementById("signup-pass-feedback");


    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }

    // Name Validation
    const checkSignupName = debounce(async (e) => {
      const name = e.target.value.trim();

      if (name.length < 3) {
        signupNameFeedback.textContent = "âš ï¸ Name must be at least 3 characters.";
        signupNameFeedback.className = "validation-feedback error";
        isSignupNameValid = false;
        return;
      }

      // Check availability
      signupNameFeedback.textContent = "Checking...";
      signupNameFeedback.className = "validation-feedback";

      const { data, error } = await supabase
        .from("users")
        .select("id")
        .eq("name", name)
        .maybeSingle();

      if (data) {
        signupNameFeedback.textContent = "âŒ Name is already taken.";
        signupNameFeedback.className = "validation-feedback error";
        isSignupNameValid = false;
      } else {
        signupNameFeedback.textContent = "âœ… Name is available!";
        signupNameFeedback.className = "validation-feedback success";
        isSignupNameValid = true;
      }
    }, 500);

    // Email Validation (Regex + DB Check)
    const checkSignupEmail = debounce(async (e) => {
      const email = e.target.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!email) {
        signupEmailFeedback.innerText = "";
        isSignupEmailValid = false;
        return;
      }

      if (!emailRegex.test(email)) {
        signupEmailFeedback.innerText = "âš ï¸ Invalid email format";
        signupEmailFeedback.className = "validation-feedback error";
        isSignupEmailValid = false;
        return;
      }

      // Check availability in DB
      signupEmailFeedback.innerText = "Checking...";
      signupEmailFeedback.className = "validation-feedback";

      const { data, error } = await supabase
        .from("users")
        .select("id")
        .eq("email", email)
        .maybeSingle();

      if (data) {
        signupEmailFeedback.innerText = "âŒ Email is already registered";
        signupEmailFeedback.className = "validation-feedback error";
        isSignupEmailValid = false;
      } else {
        signupEmailFeedback.innerText = "âœ… Email is available";
        signupEmailFeedback.className = "validation-feedback success";
        isSignupEmailValid = true;
      }
    }, 500);

    // Password Validation (Strict)
    const checkSignupPass = (e) => {
      const pass = e.target.value;

      if (pass.length === 0) {
        signupPassFeedback.innerText = "";
        isSignupPassValid = false;
        return;
      }

      // 1. Length Check
      if (pass.length < 8) {
        signupPassFeedback.innerText = "âš ï¸ Password too short (min 8 chars)";
        signupPassFeedback.className = "validation-feedback error";
        isSignupPassValid = false;
        return;
      }

      // 2. Complexity Checks
      const hasLower = /[a-z]/.test(pass);
      const hasUpper = /[A-Z]/.test(pass);
      const hasNumber = /\d/.test(pass);
      const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(pass);

      if (!hasLower || !hasUpper || !hasNumber || !hasSpecial) {
        let missing = [];
        if (!hasLower) missing.push("lowercase");
        if (!hasUpper) missing.push("uppercase");
        if (!hasNumber) missing.push("number");
        if (!hasSpecial) missing.push("symbol");

        signupPassFeedback.innerText = `âš ï¸ Weak: Missing ${missing.join(", ")}`;
        signupPassFeedback.className = "validation-feedback error";
        isSignupPassValid = false;
        return;
      }

      // 3. Common Weak Pattern Check (Simple Sequence)
      if (pass.includes("12345") || pass.toLowerCase().includes("password")) {
        signupPassFeedback.innerText = "âš ï¸ Too easy to guess (avoid '12345' or 'password')";
        signupPassFeedback.className = "validation-feedback error";
        isSignupPassValid = false;
        return;
      }

      // Valid
      signupPassFeedback.innerText = "âœ… Strong Password";
      signupPassFeedback.className = "validation-feedback success";
      isSignupPassValid = true;
    };

    signupNameInput.addEventListener("input", checkSignupName);
    signupEmailInput.addEventListener("input", checkSignupEmail);
    signupPassInput.addEventListener("input", checkSignupPass);


    // --- PASSWORD TOGGLE ---
    function setupPasswordToggle(toggleBtnId, inputId) {
      const toggleBtn = document.getElementById(toggleBtnId);
      const input = document.getElementById(inputId);

      if (!toggleBtn || !input) return;

      toggleBtn.addEventListener("click", () => {
        const type = input.getAttribute("type") === "password" ? "text" : "password";
        input.setAttribute("type", type);

        // Toggle icon
        const icon = toggleBtn.querySelector("i");
        if (type === "password") {
          icon.classList.remove("fi-rr-eye-crossed");
          icon.classList.add("fi-rr-eye");
        } else {
          icon.classList.remove("fi-rr-eye");
          icon.classList.add("fi-rr-eye-crossed");
        }
      });
    }

    setupPasswordToggle("toggleLoginPass", "login-pass");
    setupPasswordToggle("toggleSignupPass", "signup-pass");

    // --- UI TABS ---
    const loginTab = document.getElementById("login-tab");
    const signupTab = document.getElementById("signup-tab");
    const loginForm = document.getElementById("login-form");
    const signupForm = document.getElementById("signup-form");

    loginTab.onclick = () => {
      loginTab.classList.add("active");
      signupTab.classList.remove("active");
      loginForm.classList.remove("hidden");
      signupForm.classList.add("hidden");
    };

    signupTab.onclick = () => {
      signupTab.classList.add("active");
      loginTab.classList.remove("active");
      signupForm.classList.remove("hidden");
      loginForm.classList.add("hidden");
    };

    // --- GOOGLE ---
    document.querySelectorAll(".google-auth-btn").forEach(btn => {
      btn.onclick = () => loginWithGoogle();
    });

    // --- LOGIN HANDLER (With Anti-Spam) ---
    document.getElementById("login-btn").onclick = async () => {
      const btn = document.getElementById("login-btn");
      const email = document.getElementById("login-email").value.trim();
      const pass = document.getElementById("login-pass").value.trim();

      // Disable Button
      btn.disabled = true;
      btn.innerText = "Logging in...";

      // Run Login
      await login(email, pass);

      // Re-enable if it failed (if successful, page redirects anyway)
      btn.disabled = false;
      btn.innerText = "Login";
    };

    // --- SIGNUP HANDLER (With Anti-Spam) ---
    document.getElementById("signup-btn").onclick = async () => {
      const btn = document.getElementById("signup-btn");
      const name = document.getElementById("signup-name").value.trim();
      const email = document.getElementById("signup-email").value.trim();
      const pass = document.getElementById("signup-pass").value.trim();

      if (!isSignupNameValid) {
        alert("âš ï¸ Please choose a valid available name before signing up.");
        return;
      }

      if (!isSignupEmailValid) {
        alert("âš ï¸ Please enter a valid email address.");
        return;
      }

      if (!isSignupPassValid) {
        alert("âš ï¸ Password does not meet requirements (min 6 chars).");
        return;
      }

      // Disable Button
      btn.disabled = true;
      btn.innerText = "Creating Account...";

      // Run Signup
      await signup(name, email, pass);

      // Re-enable
      btn.disabled = false;
      btn.innerText = "Signup";
    };

    // --- ENTER KEY HANDLER ---
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        if (!loginForm.classList.contains("hidden")) {
          document.getElementById("login-btn").click();
        } else {
          document.getElementById("signup-btn").click();
        }
      }
    });
  </script>
</body>

</html>